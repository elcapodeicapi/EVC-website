<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Planning Test</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div id="navbar"></div>
    <h1>Planning / Portfolio Steps</h1>
    <div id="tasks"></div>

    <script>
      // New implementation: load tasks and prefill saved responses
      async function loadTasks() {
        let tasks = [];
        try {
          const res = await fetch("http://localhost:4000/tasks");
          tasks = await res.json();
        } catch (err) {
          console.error("Failed to load tasks", err);
          document.getElementById("tasks").innerHTML =
            "<p>❌ Failed to load tasks. Please try again.</p>";
          return;
        }

        const container = document.getElementById("tasks");
        container.innerHTML = "";

        for (const task of tasks) {
          // fetch saved response for each task (only if token present)
          let responseData = {};
          const token = localStorage.getItem("token");
          if (token) {
            try {
              const savedRes = await fetch(
                `http://localhost:4000/responses/${task.id}`,
                {
                  headers: { Authorization: "Bearer " + token },
                }
              );
              if (savedRes.ok) {
                responseData = await savedRes.json();
              }
            } catch (e) {
              console.warn("Could not load saved response for task", task.id);
            }
          }

          var noteText = "";
          if (responseData) {
            if (responseData.notes != null) noteText = responseData.notes;
            else if (responseData.responseText != null)
              noteText = responseData.responseText;
          }

          container.innerHTML += `
            <div class="task">
              <h3>${task.title}</h3>
              <p>${task.description}</p>
              <textarea data-taskid="${task.id}">${noteText}</textarea>
              <button onclick="saveResponse(${task.id})">Save</button>
              <hr>
            </div>
          `;
        }
      }

      async function saveResponse(taskId) {
        const textarea = document.querySelector(
          `textarea[data-taskid="${taskId}"]`
        );
        const responseText = textarea.value;

        const res = await fetch(`http://localhost:4000/responses/${taskId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + localStorage.getItem("token"),
          },
          body: JSON.stringify({ notes: responseText }),
        });

        if (res.ok) {
          alert("✅ Response saved/updated!");
        } else {
          alert("❌ Failed to save response.");
        }
      }

      loadTasks();
    </script>
    <script>
      async function loadNavbar() {
        try {
          const res = await fetch("./Navbar.html");
          if (!res.ok) throw new Error("Failed to load navbar");
          document.getElementById("navbar").innerHTML = await res.text();
        } catch (err) {
          console.error(err);
        }
      }
      loadNavbar();

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "Login.html";
      }
    </script>
  </body>
</html>
