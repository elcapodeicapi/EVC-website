<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Evidence Upload Test</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Navbar placeholder inserted at top of body -->
    <div id="navbar"></div>
    <h2>Upload Evidence</h2>
    <form id="evidenceForm" enctype="multipart/form-data">
      <input type="text" name="name" placeholder="Evidence name" required />
      <input
        type="text"
        name="type"
        placeholder="Type (e.g. pdf, image)"
        required
      />
      <input type="file" name="file" required />
      <button type="submit">Upload</button>
    </form>

    <h2>Uploaded Evidence</h2>
    <ul id="evidenceList"></ul>

    <script>
      const list = document.getElementById("evidenceList");

      // Upload Evidence handler
      document
        .getElementById("evidenceForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);

          const res = await fetch("http://localhost:4000/evidence/upload", {
            method: "POST",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            body: formData,
          });

          if (res.ok) {
            alert("✅ Evidence uploaded!");
            await loadEvidence();
          } else {
            alert("❌ Upload failed");
          }
        });

      // Assign Evidence to Task UI
      // Section markup is below the upload section

      async function loadEvidence() {
        const res = await fetch("http://localhost:4000/evidence");
        const evidence = await res.json();
        list.innerHTML = "";
        evidence.forEach((ev) => {
          const li = document.createElement("li");
          li.innerHTML = `${ev.name} (${ev.type})`;
          list.appendChild(li);
        });
      }

      loadEvidence();
    </script>

    <h2>Assign Evidence to Task</h2>
    <form id="assignForm">
      <input type="number" name="taskId" placeholder="Task ID" required />
      <input
        type="number"
        name="evidenceId"
        placeholder="Evidence ID"
        required
      />
      <button type="submit">Assign</button>
    </form>

    <script>
      document
        .getElementById("assignForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const data = Object.fromEntries(new FormData(e.target).entries());

          const res = await fetch("http://localhost:4000/taskevidence/assign", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            body: JSON.stringify(data),
          });

          if (res.ok) {
            alert("✅ Evidence assigned to task!");
          } else {
            alert("❌ Failed to assign evidence");
          }
        });
    </script>

    <!-- Load navbar HTML and provide logout function -->
    <script>
      async function loadNavbar() {
        try {
          // Evidence.html and Navbar.html are in the same folder
          const res = await fetch("./Navbar.html");
          if (!res.ok) throw new Error("Failed to load navbar");
          document.getElementById("navbar").innerHTML = await res.text();
        } catch (err) {
          console.error(err);
        }
      }
      loadNavbar();

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "Login.html";
      }
    </script>
  </body>
</html>
